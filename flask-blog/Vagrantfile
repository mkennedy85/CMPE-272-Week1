# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  # Base box - Ubuntu 22.04 LTS
  config.vm.box = "ubuntu/jammy64"
  config.vm.box_version = "20231215.0.0"

  # Network configuration - forward port 5001 from guest to host
  config.vm.network "forwarded_port", guest: 5001, host: 5001, host_ip: "127.0.0.1"

  # VM resource allocation
  config.vm.provider "virtualbox" do |vb|
    vb.name = "flask-blog-vm"
    vb.memory = "1024"  # 1GB RAM
    vb.cpus = 2
    # Enable performance monitoring
    vb.customize ["modifyvm", :id, "--hwvirtex", "on"]
    vb.customize ["modifyvm", :id, "--nestedpaging", "on"]
  end

  # Sync the flask-blog directory to VM
  config.vm.synced_folder ".", "/home/vagrant/flask-blog", 
    owner: "vagrant", group: "vagrant"

  # Provisioning script
  config.vm.provision "shell", path: "provision.sh", privileged: false

  # Optional: Run the app automatically on startup
  config.vm.provision "shell", run: "always", inline: <<-SHELL
    cd /home/vagrant/flask-blog
    # Kill any existing flask processes
    pkill -f "python.*app.py" || true
    # Start the app in background
    nohup python3 app.py > flask.log 2>&1 &
    echo "Flask blog started on port 5001"
    echo "Access it at: http://localhost:5001"
  SHELL
end